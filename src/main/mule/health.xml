<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

  <sub-flow name="salesforce-readiness-check-subflow" doc:name="Salesforce Readiness Check" doc:id="d08d6c9d-3cfe-4a2f-b5d3-1f8eb456012c">
    <try doc:name="Try" doc:id="8912fdd9-dfea-4caf-8523-a2ebbad9cebb">
      <salesforce:query config-ref="Salesforce_Config" doc:name="Health Check Query" doc:id="3ca0f0e6-53e4-4795-b9fd-e291ce0bdf81">
        <salesforce:salesforce-query><![CDATA[SELECT Id FROM Organization LIMIT 1]]></salesforce:salesforce-query>
      </salesforce:query>
      <error-handler>
        <on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="27dd4936-1fe6-4b1d-9b21-ed97204c430a">
          <logger level="INFO" doc:name="Logger" doc:id="bb1cc72e-720c-46d8-acda-6b721ea196f5" message="Salesforce health check failed"></logger>
        </on-error-continue>
      </error-handler>
    </try>
    <ee:transform doc:name="Readiness Response" doc:id="2415f79c-5b0e-4b23-a90a-5de47db8c6e7">
      <ee:message>
        <ee:set-payload>
          %dw 2.0
output application/json
---
{
  servicename: "salesforce",
  status: if(payload[0].Id == null) "down" else "up"
}
        </ee:set-payload>
      </ee:message>
    </ee:transform>
  </sub-flow>

</mule>